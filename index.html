<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMEERI SERVICES - Job Card</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fb;
            min-height: 100vh;
        }
        
        .job-card {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .company-header {
            background: #1a3a8f;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #ff0000;
        }
        
        .company-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .company-name-ar {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .card-title {
            background: #2c5fbd;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .form-section {
            padding: 25px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .parts-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .parts-table th {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-weight: bold;
        }
        
        .parts-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        .parts-table input {
            border: 1px solid #ddd;
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        
        .totals-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ccc;
        }
        
        .signature-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .signature-box {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        
        .signature-line {
            border-bottom: 1px solid #000;
            height: 40px;
            margin: 10px 0;
        }
        
        .btn {
            background: #1a3a8f;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2c5fbd;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            background: #dc3545;
        }
        
        .btn-small:hover {
            background: #c82333;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .signature-link {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #1a3a8f;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .job-card, .job-card * {
                visibility: visible;
            }
            .job-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .form-group {
                min-width: 100%;
            }
            .signature-row {
                flex-direction: column;
            }
            .signature-box {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="job-card">
        <!-- Company Header -->
        <div class="company-header">
            <div class="company-name">AMEERI SERVICES CO. W.L.L</div>
            <div class="company-name-ar">شركة أميري للخدمات ذ.م.م</div>
        </div>

        <!-- Job Card Title -->
        <div class="card-title">GARAGE - JOB CARD</div>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Job Card Form -->
        <div class="form-section">
            <!-- Date and Work Order -->
            <div class="form-row">
                <div class="form-group">
                    <label for="date">DATE</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="workOrderNo">WORK ORDER NO</label>
                    <input type="text" id="workOrderNo" required value="2839">
                </div>
            </div>

            <!-- Company and Driver -->
            <div class="form-row">
                <div class="form-group">
                    <label for="companyName">COMPANY NAME</label>
                    <input type="text" id="companyName" value="Ameeri Services">
                </div>
                <div class="form-group">
                    <label for="userName">NAME OF USER/DRIVER</label>
                    <input type="text" id="userName" value="NyxN">
                </div>
            </div>

            <!-- Vehicle Information -->
            <div class="form-row">
                <div class="form-group">
                    <label for="vehicleNo">VEHICLE NO</label>
                    <input type="text" id="vehicleNo" value="609712">
                </div>
                <div class="form-group">
                    <label for="mileage">MILEAGE</label>
                    <input type="text" id="mileage" value="158550km">
                </div>
                <div class="form-group">
                    <label for="year">YEAR</label>
                    <input type="text" id="year" value="2017">
                </div>
                <div class="form-group">
                    <label for="make">MAKE</label>
                    <input type="text" id="make" value="TOYOTA">
                </div>
                <div class="form-group">
                    <label for="model">MODEL</label>
                    <input type="text" id="model" value="COPOLUT">
                </div>
            </div>

            <!-- Parts Table -->
            <table class="parts-table">
                <thead>
                    <tr>
                        <th>PARTS/ITEM</th>
                        <th>QTY</th>
                        <th>PRICE</th>
                        <th>SERVICE PERFORMED</th>
                        <th class="no-print">ACTION</th>
                    </tr>
                </thead>
                <tbody id="partsBody">
                    <tr>
                        <td><input type="text" value="Tyezi 195/65 R15"></td>
                        <td><input type="number" value="2" min="1"></td>
                        <td><input type="number" value="30.800" step="0.001"></td>
                        <td><input type="text" value="Tyezi 195/65 R15"></td>
                        <td class="no-print">
                            <button type="button" class="btn btn-small">Remove</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <button type="button" class="btn no-print" id="addBtn">+ Add Part/Service</button>

            <!-- Totals Section -->
            <div class="totals-section">
                <div class="total-row">
                    <span>TOTAL PARTS:</span>
                    <span id="totalParts">61.600 BD</span>
                </div>
                <div class="total-row">
                    <span>TOTAL LABOUR:</span>
                    <span><input type="number" id="labour" value="5.000" step="0.001" style="width: 100px; display: inline;"> BD</span>
                </div>
                <div class="total-row" style="font-size: 18px; font-weight: bold;">
                    <span>TOTAL PARTS & LABOUR:</span>
                    <span id="grandTotal">66.600 BD</span>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="signature-section">
                <!-- Vehicle Maintenance Manager on Top -->
                <div class="signature-row" style="margin-bottom: 30px;">
                    <div class="signature-box">
                        <label>VEHICLE MAINTENANCE MANAGER</label>
                        <div class="signature-line" id="maintenanceManagerSign"></div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;" id="maintenanceManagerStatus">[Pending]</div>
                    </div>
                </div>

                <!-- Other Three Signatures at Bottom -->
                <div class="signature-row">
                    <div class="signature-box">
                        <label>MECHANIC SIGNATURE</label>
                        <div class="signature-line" id="mechanicSign"></div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;" id="mechanicStatus">[Pending]</div>
                    </div>
                    <div class="signature-box">
                        <label>USER/DRIVER</label>
                        <div class="signature-line" id="driverSign"></div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;" id="driverStatus">[Pending]</div>
                    </div>
                    <div class="signature-box">
                        <label>APPROVED BY</label>
                        <div class="signature-line" id="managerSign"></div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;" id="managerStatus">[Pending]</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="text-align: center; margin-top: 30px;" class="no-print">
                <button type="button" class="btn" id="saveBtn">Save Job Card</button>
                <button type="button" class="btn" id="printBtn">Print Job Card</button>
                <button type="button" class="btn" id="signatureBtn">Attach Signatures</button>
            </div>

            <!-- Hidden fields to keep attached signature data -->
            <input type="hidden" id="mechanicSignatureData" name="mechanicSignatureData" value="">
            <input type="hidden" id="driverSignatureData" name="driverSignatureData" value="">
            <input type="hidden" id="maintenanceManagerSignatureData" name="maintenanceManagerSignatureData" value="">
            <input type="hidden" id="managerSignatureData" name="managerSignatureData" value="">
        </div>
    </div>

    <!-- Signature Links Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <h2>Attach Signatures for Work Order: <span id="modalWorkOrder"></span></h2>
            
            <div class="signature-link">
                <strong>🚗 Vehicle Maintenance Manager:</strong><br>
                <input type="file" id="maintenanceManagerFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('maintenanceManager')">Attach Signature</button>
                <div id="maintenanceManagerPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>🔧 Mechanic Signature:</strong><br>
                <input type="file" id="mechanicFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('mechanic')">Attach Signature</button>
                <div id="mechanicPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>👤 User/Driver Signature:</strong><br>
                <input type="file" id="driverFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('driver')">Attach Signature</button>
                <div id="driverPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>✅ Manager Signature:</strong><br>
                <input type="file" id="managerFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('manager')">Attach Signature</button>
                <div id="managerPreview" style="margin-top:10px;"></div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // API URL - UPDATE THIS WITH YOUR ACTUAL APPS SCRIPT URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbxT24I2_Z99nCl-kjPqQ8ewdJPP-0NMVtWOIgSDAigoU7UbZc_C-DjF-JsF_5K_qnRRpA/exec';

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Job Card System Loaded");
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            // Add event listeners
            document.getElementById('addBtn').addEventListener('click', addRow);
            document.getElementById('printBtn').addEventListener('click', printJobCard);
            document.getElementById('signatureBtn').addEventListener('click', showSignatureModal);
            document.getElementById('saveBtn').addEventListener('click', saveJobCard);
            document.getElementById('labour').addEventListener('input', calculateTotals);

            // Parts table event delegation
            document.getElementById('partsBody').addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-small')) {
                    removeRow(e.target);
                }
            });

            document.getElementById('partsBody').addEventListener('input', function(e) {
                if (e.target.type === 'number') {
                    calculateTotals();
                }
            });

            calculateTotals();
        });

        // Add new row
        function addRow() {
            const tbody = document.getElementById('partsBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Part/Item"></td>
                <td><input type="number" value="1" min="1"></td>
                <td><input type="number" value="0" step="0.001"></td>
                <td><input type="text" placeholder="Service Performed"></td>
                <td class="no-print">
                    <button type="button" class="btn btn-small">Remove</button>
                </td>
            `;
            tbody.appendChild(newRow);
            calculateTotals();
        }

        // Remove row
        function removeRow(button) {
            const row = button.closest('tr');
            if (row && document.getElementById('partsBody').children.length > 1) {
                row.remove();
                calculateTotals();
            }
        }

        // Calculate totals
        function calculateTotals() {
            let partsTotal = 0;
            const rows = document.querySelectorAll('#partsBody tr');

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
                const price = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
                partsTotal += qty * price;
            });

            const labour = parseFloat(document.getElementById('labour').value) || 0;
            const grandTotal = partsTotal + labour;

            document.getElementById('totalParts').textContent = partsTotal.toFixed(3) + ' BD';
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(3) + ' BD';
        }

        // Print job card
        function printJobCard() {
            window.print();
        }

        // Show signature modal
        function showSignatureModal() {
            const workOrder = document.getElementById('workOrderNo').value;
            if (!workOrder) { 
                showStatus('Please enter Work Order No first', 'error');
                return; 
            }
            document.getElementById('modalWorkOrder').textContent = workOrder;
            document.getElementById('signatureModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('signatureModal').style.display = 'none';
        }

        // Attach signature
        function attachSignature(role) {
            const input = document.getElementById(role + 'File');
            if (!input.files.length) {
                showStatus('Please select an image file first', 'error');
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const dataUrl = e.target.result;

                // Update preview
                const preview = document.getElementById(role + 'Preview');
                preview.innerHTML = `<img src="${dataUrl}" style="max-width: 100%; max-height: 120px; border: 1px solid #ddd;">`;

                // Update signature line
                const signLine = document.getElementById(role + 'Sign');
                signLine.innerHTML = `<img src="${dataUrl}" style="max-height: 40px;">`;
                signLine.style.borderBottom = 'none';

                // Update status
                document.getElementById(role + 'Status').textContent = '[Attached]';

                // Store in hidden field
                document.getElementById(role + 'SignatureData').value = dataUrl;

                showStatus('Signature attached successfully!', 'success');
            };

            reader.readAsDataURL(file);
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Collect parts data
        function getPartsData() {
            const parts = [];
            const rows = document.querySelectorAll('#partsBody tr');
            
            rows.forEach(row => {
                const partName = row.querySelector('td:nth-child(1) input').value;
                const qty = row.querySelector('td:nth-child(2) input').value;
                const price = row.querySelector('td:nth-child(3) input').value;
                const service = row.querySelector('td:nth-child(4) input').value;
                
                if (partName || service) {
                    parts.push({ partName, qty, price, service });
                }
            });
            
            return parts;
        }

        // Save job card
        async function saveJobCard() {
            const required = ['workOrderNo', 'vehicleNo', 'companyName', 'userName'];
            for (const field of required) {
                if (!document.getElementById(field).value.trim()) {
                    showStatus(`Please fill in ${field}`, 'error');
                    return;
                }
            }

            showStatus('Saving job card...', 'success');

            const jobCardData = {
                date: document.getElementById('date').value,
                workOrderNo: document.getElementById('workOrderNo').value,
                companyName: document.getElementById('companyName').value,
                userName: document.getElementById('userName').value,
                vehicleNo: document.getElementById('vehicleNo').value,
                mileage: document.getElementById('mileage').value,
                year: document.getElementById('year').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                partsData: JSON.stringify(getPartsData()),
                totalParts: document.getElementById('totalParts').textContent.replace(' BD', ''),
                totalLabour: document.getElementById('labour').value,
                grandTotal: document.getElementById('grandTotal').textContent.replace(' BD', ''),
                mechanicSignatureData: document.getElementById('mechanicSignatureData').value,
                driverSignatureData: document.getElementById('driverSignatureData').value,
                maintenanceManagerSignatureData: document.getElementById('maintenanceManagerSignatureData').value,
                managerSignatureData: document.getElementById('managerSignatureData').value
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jobCardData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('✅ ' + result.message, 'success');
                } else {
                    showStatus('❌ ' + (result.message || result.error), 'error');
                }
            } catch (error) {
                showStatus('❌ Network error. Please try again.', 'error');
                console.error('Error:', error);
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.id === 'signatureModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>

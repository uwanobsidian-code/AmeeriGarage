function doPost(e) {
  try {
    // Parse the JSON data from the request
    const data = JSON.parse(e.postData.contents);

    // Get the spreadsheet
    const SPREADSHEET_ID = '1YvM5vvlWT4Pp5GIGhVZwScihX_74hrDE1_0e2ou9MvQ';
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheets()[0];

    // Parse the parts data from the form
    let partsData = [];
    try {
      partsData = JSON.parse(data.partsData || '[]');
    } catch (error) {
      partsData = [];
    }

    let savedRows = 0;

    if (partsData.length > 0) {
      partsData.forEach((part, index) => {
        const rowData = [
          data.date || '',
          data.workOrderNo || '',
          data.vehicleNo || '',
          data.mileage || '',
          data.year || '',
          data.make || '',
          data.model || '',
          data.companyName || '',
          data.userName || '',
          '', // Payment (empty)
          part.partName || '',
          part.qty || '',
          part.price || '',
          part.service || '',
          (parseFloat(part.qty || 0) * parseFloat(part.price || 0)).toFixed(3),
          index === 0 ? data.totalLabour : '',
          index === 0 ? data.grandTotal : '',
          data.mechanicSignatureData ? 'Yes' : 'No',
          data.driverSignatureData ? 'Yes' : 'No',
          data.managerSignatureData ? 'Yes' : 'No',
          data.maintenanceManagerSignatureData ? 'Yes' : 'No',
          'Completed',
          new Date()
        ];
        sheet.appendRow(rowData);
        savedRows++;
      });
    } else {
      const rowData = [
        data.date || '',
        data.workOrderNo || '',
        data.vehicleNo || '',
        data.mileage || '',
        data.year || '',
        data.make || '',
        data.model || '',
        data.companyName || '',
        data.userName || '',
        '', // Payment (empty)
        '', // Part Name (empty)
        '', // Part Quantity (empty)
        '', // Part Price (empty)
        '', // Service Performed (empty)
        data.totalParts || '',
        data.totalLabour || '',
        data.grandTotal || '',
        data.mechanicSignatureData ? 'Yes' : 'No',
        data.driverSignatureData ? 'Yes' : 'No',
        data.managerSignatureData ? 'Yes' : 'No',
        data.maintenanceManagerSignatureData ? 'Yes' : 'No',
        'Completed',
        new Date()
      ];
      sheet.appendRow(rowData);
      savedRows++;
    }

    // Return success with CORS headers
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: `Job Card saved successfully! ${savedRows} row(s) added.`,
      rowsSaved: savedRows
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString(),
      message: 'Failed to save job card'
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
  }
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    message: 'Ameeri Services Job Card API is running!',
    status: 'active'
  }))
  .setMimeType(ContentService.MimeType.JSON)
  .setHeader('Access-Control-Allow-Origin', '*')
  .setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS')
  .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}

// Handle preflight OPTIONS requests
function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}

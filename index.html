<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMEERI SERVICES - Job Card</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fb;
        }
        .job-card {
            width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .company-header {
            background: #1a3a8f;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #ff0000;
        }
        .company-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .company-name-ar {
            font-size: 18px;
            opacity: 0.9;
        }
        .card-title {
            background: #2c5fbd;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .form-section {
            padding: 25px;
        }
        .form-row {
            display: flex;
            margin-bottom: 15px;
            gap: 20px;
        }
        .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .parts-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .parts-table th {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-weight: bold;
        }
        .parts-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .parts-table input {
            border: 1px solid #ddd;
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        .totals-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ccc;
        }
        .signature-row {
            display: flex;
            gap: 20px;
        }
        .signature-box {
            flex: 1;
            text-align: center;
        }
        .signature-line {
            border-bottom: 1px solid #000;
            height: 40px;
            margin: 10px 0;
        }
        .btn {
            background: #1a3a8f;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            background: #dc3545;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }

        /* PRINT STYLES - FIXED */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .job-card {
                width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                border: none !important;
            }
            .no-print {
                display: none !important;
            }
            .company-header {
                background: #1a3a8f !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .card-title {
                background: #2c5fbd !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Remove browser print headers and footers */
            @page {
                margin: 0.5cm;
                size: auto;
            }
            
            /* Hide URL and date/time in print */
            body::before, body::after {
                display: none !important;
            }
        }
        .company-header img {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Signature Links Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
        }
        .signature-link {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #1a3a8f;
        }
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="job-card">
        <!-- Company Header -->
        <div class="company-header">
            <div class="logo-container">
                <img src="ameeriserviceswhitelogo.png" alt="Ameeri Services Logo" style="max-height: 80px; display: block; margin: 0 auto;">
            </div>
            <div class="company-name">AMEERI SERVICES CO. W.L.L</div>
            <div class="company-name-ar">شركة أميري للخدمات ذ.م.م</div>
        </div>

        <!-- Job Card Title -->
        <div class="card-title">GARAGE - JOB CARD</div>

        <!-- Job Card Form -->
        <div class="form-section">
            <form id="jobCardForm">
                <!-- Date and Work Order -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">DATE</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="workOrderNo">WORK ORDER NO</label>
                        <input type="text" id="workOrderNo" required value="2839">
                    </div>
                </div>

                <!-- Company and Driver -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyName">COMPANY NAME</label>
                        <input type="text" id="companyName" value="Ameeri Services">
                    </div>
                    <div class="form-group">
                        <label for="userName">NAME OF USER/DRIVER</label>
                        <input type="text" id="userName" value="DriverName">
                    </div>
                </div>

                <!-- Vehicle Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="vehicleNo">VEHICLE NO</label>
                        <input type="text" id="vehicleNo" value="VehicleNo">
                    </div>
                    <div class="form-group">
                        <label for="mileage">MILEAGE</label>
                        <input type="text" id="mileage" value="000km">
                    </div>
                    <div class="form-group">
                        <label for="year">YEAR</label>
                        <input type="text" id="year" value="Vehicleyear">
                    </div>
                    <div class="form-group">
                        <label for="make">MAKE</label>
                        <input type="text" id="make" value="Vehiclemake">
                    </div>
                    <div class="form-group">
                        <label for="model">MODEL</label>
                        <input type="text" id="model" value="Vehiclemodel">
                    </div>
                </div>

                <!-- Parts Table -->
                <table class="parts-table">
                    <thead>
                        <tr>
                            <th>PARTS/ITEM</th>
                            <th>QTY</th>
                            <th>PRICE</th>
                            <th>SERVICE PERFORMED</th>
                            <th class="no-print">ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="partsBody">
                        <tr>
                            <td><input type="text" value="Tyezi 195/65 R15"></td>
                            <td><input type="number" value="2" min="1" id="qty1"></td>
                            <td><input type="number" value="30.800" step="0.001" id="price1"></td>
                            <td><input type="text" value="Tyezi 195/65 R15"></td>
                            <td class="no-print">
                                <button type="button" class="btn btn-small" id="remove1">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <button type="button" class="btn no-print" id="addBtn">+ Add Part/Service</button>

                <!-- Totals Section -->
                <div class="totals-section">
                    <div class="total-row">
                        <span>TOTAL PARTS:</span>
                        <span id="totalParts">61.600 BD</span>
                    </div>
                    <div class="total-row">
                        <span>TOTAL LABOUR:</span>
                        <span><input type="number" id="labour" value="5.000" step="0.001" style="width: 100px; display: inline;"> BD</span>
                    </div>
                    <div class="total-row" style="font-size: 18px; font-weight: bold;">
                        <span>TOTAL PARTS & LABOUR:</span>
                        <span id="grandTotal">66.600 BD</span>
                    </div>
                </div>

                <!-- Signature Section -->
                <div class="signature-section">
                    <!-- Vehicle Maintenance Manager on Top -->
                    <div class="signature-row" style="margin-bottom: 30px;">
                        <div class="signature-box">
                            <label>VEHICLE MAINTENANCE MANAGER</label>
                            <div class="signature-line" id="maintenanceManagerSign"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" id="maintenanceManagerStatus">[Pending]</div>
                        </div>
                    </div>

                    <!-- Other Three Signatures at Bottom -->
                    <div class="signature-row">
                        <div class="signature-box">
                            <label>MECHANIC SIGNATURE</label>
                            <div class="signature-line" id="mechanicSign"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" id="mechanicStatus">[Pending]</div>
                        </div>
                        <div class="signature-box">
                            <label>USER/DRIVER</label>
                            <div class="signature-line" id="driverSign"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" id="driverStatus">[Pending]</div>
                        </div>
                        <div class="signature-box">
                            <label>APPROVED BY</label>
                            <div class="signature-line" id="managerSign"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" id="managerStatus">[Pending]</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="text-align: center; margin-top: 30px;" class="no-print">
                    <button type="submit" class="btn">Save Job Card</button>
                    <button type="button" class="btn" id="printBtn">Print Job Card</button>
                    <button type="button" class="btn" id="signatureBtn">Get Signature Links</button>
                </div>

                <!-- Hidden fields to keep attached signature data -->
                <input type="hidden" id="mechanicSignatureData" name="mechanicSignatureData" value="">
                <input type="hidden" id="driverSignatureData" name="driverSignatureData" value="">
                <input type="hidden" id="maintenanceManagerSignatureData" name="maintenanceManagerSignatureData" value="">
                <input type="hidden" id="managerSignatureData" name="managerSignatureData" value="">
            </form>
        </div>
    </div>

    <!-- Signature Links Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <h2>Attach Signatures for Work Order: <span id="modalWorkOrder"></span></h2>
            
            <div class="signature-link">
                <strong>🚗 Vehicle Maintenance Manager:</strong><br>
                <input type="file" id="maintenanceManagerFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('maintenanceManager')">Attach</button>
                <button class="btn" onclick="uploadSignature('maintenanceManager')">Upload</button>
                <div id="maintenanceManagerPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>🔧 Mechanic Signature:</strong><br>
                <input type="file" id="mechanicFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('mechanic')">Attach</button>
                <button class="btn" onclick="uploadSignature('mechanic')">Upload</button>
                <div id="mechanicPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>👤 User/Driver Signature:</strong><br>
                <input type="file" id="driverFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('driver')">Attach</button>
                <button class="btn" onclick="uploadSignature('driver')">Upload</button>
                <div id="driverPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>✅ Manager Signature:</strong><br>
                <input type="file" id="managerFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('manager')">Attach</button>
                <button class="btn" onclick="uploadSignature('manager')">Upload</button>
                <div id="managerPreview" style="margin-top:10px;"></div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Set today's date
        document.getElementById('date').valueAsDate = new Date();

        // Initialize when page loads
        window.onload = function() {
            console.log("Init");

            const addBtn = document.getElementById('addBtn');
            const partsBody = document.getElementById('partsBody');
            const printBtn = document.getElementById('printBtn');
            const signatureBtn = document.getElementById('signatureBtn');
            const labourEl = document.getElementById('labour');
            const form = document.getElementById('jobCardForm');

            if (addBtn) addBtn.addEventListener('click', addRow);
            if (printBtn) printBtn.addEventListener('click', () => window.print());
            if (signatureBtn) signatureBtn.addEventListener('click', showLinks);
            if (labourEl) labourEl.addEventListener('input', calculateTotals);
            if (form) form.addEventListener('submit', async function(e){ 
    e.preventDefault(); 
    
    // Collect parts data from the table
    const partsData = [];
    const rows = document.querySelectorAll('#partsBody tr');

    rows.forEach((row) => {
        const partName = row.querySelector('td:nth-child(1) input')?.value || '';
        const qty = row.querySelector('td:nth-child(2) input')?.value || '';
        const price = row.querySelector('td:nth-child(3) input')?.value || '';
        const service = row.querySelector('td:nth-child(4) input')?.value || '';
        
        if (partName || service) {
            partsData.push({
                partName: partName,
                qty: qty,
                price: price,
                service: service
            });
        }
    });
    
    // Collect all data from the form
    const jobCardData = {
        workOrderNo: document.getElementById('workOrderNo').value,
        date: document.getElementById('date').value,
        companyName: document.getElementById('companyName').value,
        userName: document.getElementById('userName').value,
        vehicleNo: document.getElementById('vehicleNo').value,
        mileage: document.getElementById('mileage').value,
        year: document.getElementById('year').value,
        make: document.getElementById('make').value,
        model: document.getElementById('model').value,
        totalParts: document.getElementById('totalParts').textContent.replace(' BD', ''),
        totalLabour: document.getElementById('labour').value,
        grandTotal: document.getElementById('grandTotal').textContent.replace(' BD', ''),
        partsData: JSON.stringify(partsData),
        mechanicSignatureData: document.getElementById('mechanicSignatureData').value,
        driverSignatureData: document.getElementById('driverSignatureData').value,
        maintenanceManagerSignatureData: document.getElementById('maintenanceManagerSignatureData').value,
        managerSignatureData: document.getElementById('managerSignatureData').value
    };
    
    try {
    console.log('Sending data to Google Sheets...');
    
    // Use CORS proxy for GitHub Pages
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbz_VaSuK0ZL7PgEp0bWZ86UdxO1o7g7jhkwlB74FBQSjgDyg4M0obMOZKyo9Y7b2riw5w/exec';
    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(scriptUrl);
   if (form) form.addEventListener('submit', async function(e){ 
    e.preventDefault(); 
    
    // Collect parts data from the table
    const partsData = [];
    const rows = document.querySelectorAll('#partsBody tr');

    rows.forEach((row) => {
        const partName = row.querySelector('td:nth-child(1) input')?.value || '';
        const qty = row.querySelector('td:nth-child(2) input')?.value || '';
        const price = row.querySelector('td:nth-child(3) input')?.value || '';
        const service = row.querySelector('td:nth-child(4) input')?.value || '';
        
        if (partName || service) {
            partsData.push({
                partName: partName,
                qty: qty,
                price: price,
                service: service
            });
        }
    });
    
    // Collect all data from the form
    const jobCardData = {
        workOrderNo: document.getElementById('workOrderNo').value,
        date: document.getElementById('date').value,
        companyName: document.getElementById('companyName').value,
        userName: document.getElementById('userName').value,
        vehicleNo: document.getElementById('vehicleNo').value,
        mileage: document.getElementById('mileage').value,
        year: document.getElementById('year').value,
        make: document.getElementById('make').value,
        model: document.getElementById('model').value,
        totalParts: document.getElementById('totalParts').textContent.replace(' BD', ''),
        totalLabour: document.getElementById('labour').value,
        grandTotal: document.getElementById('grandTotal').textContent.replace(' BD', ''),
        partsData: JSON.stringify(partsData),
        mechanicSignatureData: document.getElementById('mechanicSignatureData').value,
        driverSignatureData: document.getElementById('driverSignatureData').value,
        maintenanceManagerSignatureData: document.getElementById('maintenanceManagerSignatureData').value,
        managerSignatureData: document.getElementById('managerSignatureData').value
    };
    
    try {
        // Send to Google Sheets - using direct connection (was working before)
        const response = await fetch('https://script.google.com/macros/s/AKfycbz_VaSuK0ZL7PgEp0bWZ86UdxO1o7g7jhkwlB74FBQSjgDyg4M0obMOZKyo9Y7b2riw5w/exec', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jobCardData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ Job Card Saved to Google Sheets!');
            // Optional: Reset form
            document.getElementById('jobCardForm').reset();
            document.getElementById('date').valueAsDate = new Date();
        } else {
            alert('❌ Error: ' + result.error);
        }
    } catch (error) {
        alert('❌ Network error: ' + error.message);
    }
});
            // Delegation: handle input changes inside partsBody and remove button clicks
            if (partsBody) {
                partsBody.addEventListener('input', function(e) {
                    // only recalc when qty or price changed
                    if (e.target && (e.target.matches('input[type="number"]') || e.target.matches('input'))) {
                        calculateTotals();
                    }
                });
                partsBody.addEventListener('click', function(e) {
                    if (e.target && e.target.matches('.btn-small')) {
                        removeRow(e.target);
                    }
                });
            }

            // Make sure existing first-row inputs trigger calculate
            const q1 = document.getElementById('qty1');
            const p1 = document.getElementById('price1');
            if (q1) q1.addEventListener('input', calculateTotals);
            if (p1) p1.addEventListener('input', calculateTotals);

            calculateTotals();
        };

        // Add new row
        function addRow() {
            console.log("Add row");
            const tbody = document.getElementById('partsBody');
            const rowCount = tbody.children.length + 1;

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Part/Item"></td>
                <td><input type="number" value="1" min="1" id="qty${rowCount}"></td>
                <td><input type="number" value="0" step="0.001" id="price${rowCount}"></td>
                <td><input type="text" placeholder="Service Performed"></td>
                <td class="no-print">
                    <button type="button" class="btn btn-small">Remove</button>
                </td>
            `;
            tbody.appendChild(newRow);

            // add listeners for the newly created inputs (safe even if delegation exists)
            const qty = document.getElementById('qty' + rowCount);
            const price = document.getElementById('price' + rowCount);
            if (qty) qty.addEventListener('input', calculateTotals);
            if (price) price.addEventListener('input', calculateTotals);

            calculateTotals();
        }

        // Remove row (uses closest to be robust)
        function removeRow(button) {
            console.log("Remove row");
            const row = button.closest('tr');
            if (row) row.remove();
            calculateTotals();
        }

        // Calculate totals (price is now in 3rd column after removing Unit)
        function calculateTotals() {
            let partsTotal = 0;
            const rows = document.querySelectorAll('#partsBody tr');

            rows.forEach((row, index) => {
                const qtyInput = row.querySelector('td:nth-child(2) input');
                const priceInput = row.querySelector('td:nth-child(3) input');

                const qty = parseFloat(qtyInput?.value) || 0;
                const price = parseFloat(priceInput?.value) || 0;
                const rowTotal = qty * price;

                partsTotal += rowTotal;
            });

            const labour = parseFloat(document.getElementById('labour')?.value) || 0;
            const grandTotal = partsTotal + labour;

            document.getElementById('totalParts').textContent = partsTotal.toFixed(3) + ' BD';
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(3) + ' BD';
        }

        // Show signature modal (now for attach/upload)
        function showLinks() {
            const workOrder = document.getElementById('workOrderNo').value;
            if (!workOrder) { alert('Please enter Work Order No first'); return; }
            document.getElementById('modalWorkOrder').textContent = workOrder;

            // clear previous previews if any
            ['mechanic','driver','maintenanceManager','manager'].forEach(role => {
                const prev = document.getElementById(role + 'Preview');
                if (prev) prev.innerHTML = '';
            });

            document.getElementById('signatureModal').style.display = 'block';
        }

        // Attach signature locally and show preview + place on job card
        function attachSignature(role) {
            const input = document.getElementById(role + 'File');
            if (!input || !input.files || input.files.length === 0) {
                alert('Choose an image file first.');
                return;
            }
            const file = input.files[0];
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;

                // Preview inside modal
                const preview = document.getElementById(role + 'Preview');
                if (preview) {
                    preview.innerHTML = '';
                    const pvImg = document.createElement('img');
                    pvImg.src = dataUrl;
                    pvImg.style.maxWidth = '100%';
                    pvImg.style.maxHeight = '120px';
                    preview.appendChild(pvImg);
                }

                // Place signature image into the job card signature area
                const signLine = document.getElementById(role + 'Sign');
                if (signLine) {
                    signLine.innerHTML = '';
                    signLine.style.borderBottom = 'none';
                    signLine.style.height = 'auto';
                    signLine.style.padding = '6px 0';

                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.alt = `${role} signature`;
                    img.style.maxHeight = '40px';
                    img.style.display = 'block';
                    img.style.margin = '0 auto';

                    signLine.appendChild(img);
                }

                const status = document.getElementById(role + 'Status');
                if (status) status.textContent = '[Attached]';

                // store data URL in hidden input so Save Job Card will include it
                const hidden = document.getElementById(role + 'SignatureData');
                if (hidden) hidden.value = dataUrl;

                // store data URL on input element for possible client-only upload
                input.dataset.preview = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        // Upload signature file to server endpoint (requires server-side /upload-signature)
        function uploadSignature(role) {
            const input = document.getElementById(role + 'File');
            if (!input || !input.files || input.files.length === 0) {
                alert('Choose an image file first.');
                return;
            }
            const file = input.files[0];

            const workOrder = document.getElementById('workOrderNo').value || '';
            const form = new FormData();
            form.append('file', file);
            form.append('role', role);
            form.append('workOrder', workOrder);

            // Use explicit server URL — change port/host when hosted
            const uploadUrl = 'http://localhost:3000/upload-signature';

            fetch(uploadUrl, {
                method: 'POST',
                body: form
            }).then(async response => {
                if (!response.ok) {
                    // attempt to read server message/body
                    let bodyText = '';
                    try { bodyText = await response.text(); } catch {}
                    throw new Error('Upload failed: ' + response.status + ' ' + bodyText);
                }
                return response.json().catch(()=>({ ok: true }));
            }).then(json => {
                alert('Upload successful.');
            }).catch(err => {
                alert('Upload failed. When hosted live, provide a server endpoint /upload-signature to accept multipart/form-data. Error: ' + (err.message || err));
            });
        }

        function closeModal() {
            document.getElementById('signatureModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target && event.target.id === 'signatureModal') closeModal();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMEERI SERVICES - Job Card System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fb;
        }
        .job-card {
            width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .company-header {
            background: #1a3a8f;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #ffc107;
        }
        .company-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .company-name-ar {
            font-size: 18px;
            opacity: 0.9;
        }
        .card-title {
            background: #2c5fbd;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        .form-section {
            padding: 25px;
        }
        .form-row {
            display: flex;
            margin-bottom: 15px;
            gap: 20px;
        }
        .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .parts-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .parts-table th {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-weight: bold;
        }
        .parts-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .parts-table input {
            border: 1px solid #ddd;
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        .totals-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ccc;
        }
        .signature-row {
            display: flex;
            gap: 20px;
        }
        .signature-box {
            flex: 1;
            text-align: center;
        }
        .signature-line {
            border-bottom: 1px solid #000;
            height: 40px;
            margin: 10px 0;
        }
        .btn {
            background: #1a3a8f;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            background: #dc3545;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 10px;
        }
        .logo-img {
            max-height: 80px;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .share-section {
            margin: 20px 0;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            border: 2px solid #1a3a8f;
        }
        .share-link {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin: 10px 0;
            word-break: break-all;
        }

        /* PRINT STYLES */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .job-card {
                width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                border: 1px solid #000 !important;
            }
            .no-print {
                display: none !important;
            }
            .company-header {
                background: #1a3a8f !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .card-title {
                background: #2c5fbd !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* Signature Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
        }
        .signature-link {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #1a3a8f;
        }
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="job-card">
        <!-- Company Header -->
        <div class="company-header">
            <div class="logo-container">
                <img src="ameeriserviceswhitelogo.png" alt="AMEERI SERVICES Logo" class="logo-img">
            </div>
            <div class="company-name">AMEERI SERVICES CO. W.L.L</div>
            <div class="company-name-ar">شركة أميري للخدمات ذ.م.م</div>
        </div>

        <!-- Job Card Title -->
        <div class="card-title">GARAGE - JOB CARD</div>

        <!-- Job Card Form -->
        <div class="form-section">
            <form id="jobCardForm">
                <!-- Date and Work Order -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">DATE</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="workOrderNo">WORK ORDER NO</label>
                        <input type="text" id="workOrderNo" required>
                    </div>
                </div>

                <!-- Company and Driver -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyName">COMPANY NAME</label>
                        <input type="text" id="companyName">
                    </div>
                    <div class="form-group">
                        <label for="userName">NAME OF USER/DRIVER</label>
                        <input type="text" id="userName">
                    </div>
                </div>

                <!-- Vehicle Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="vehicleNo">VEHICLE NO</label>
                        <input type="text" id="vehicleNo">
                    </div>
                    <div class="form-group">
                        <label for="mileage">MILEAGE</label>
                        <input type="text" id="mileage">
                    </div>
                    <div class="form-group">
                        <label for="year">YEAR</label>
                        <input type="text" id="year">
                    </div>
                    <div class="form-group">
                        <label for="make">MAKE</label>
                        <input type="text" id="make">
                    </div>
                    <div class="form-group">
                        <label for="model">MODEL</label>
                        <input type="text" id="model">
                    </div>
                </div>

                <!-- Parts Table -->
                <table class="parts-table">
                    <thead>
                        <tr>
                            <th>PARTS/ITEM</th>
                            <th>QTY</th>
                            <th>PRICE</th>
                            <th>SERVICE PERFORMED</th>
                            <th class="no-print">ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="partsBody">
                        <tr>
                            <td><input type="text" placeholder="Part/Item"></td>
                            <td><input type="number" value="1" min="1"></td>
                            <td><input type="number" value="0" step="0.001"></td>
                            <td><input type="text" placeholder="Service Performed"></td>
                            <td class="no-print">
                                <button type="button" class="btn btn-small remove-btn">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <button type="button" class="btn no-print" id="addBtn">+ Add Part/Service</button>

                <!-- Totals Section -->
                <div class="totals-section">
                    <div class="total-row">
                        <span>TOTAL PARTS:</span>
                        <span id="totalParts">0.000 BD</span>
                    </div>
                    <div class="total-row">
                        <span>TOTAL LABOUR:</span>
                        <span><input type="number" id="labour" value="0.000" step="0.001" style="width: 100px; display: inline;"> BD</span>
                    </div>
                    <div class="total-row" style="font-size: 18px; font-weight: bold;">
                        <span>TOTAL PARTS & LABOUR:</span>
                        <span id="grandTotal">0.000 BD</span>
                    </div>
                </div>

                <!-- Shareable Link Section -->
                <div class="share-section no-print" id="shareSection">
                    <h3>🔗 Shareable Job Card Link</h3>
                    <div id="shareLinkContainer" style="display: none;">
                        <div class="share-link" id="shareLink"></div>
                        <button type="button" class="btn copy-btn" onclick="copyShareLink()">Copy Link</button>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                            Share this link with mechanic, driver, and manager to collect signatures
                        </p>
                    </div>
                    <button type="button" class="btn" id="generateLinkBtn" onclick="saveJobCardAndGenerateLink()">
                        💾 Save & Generate Shareable Link
                    </button>
                </div>

                <!-- Signature Section -->
                <div class="signature-section">
                    <div class="signature-row">
                        <div class="signature-box">
                            <label>MECHANIC SIGNATURE</label>
                            <div class="signature-line" id="mechanicSign"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" id="mechanicStatus">[Pending]</div>
                        </div>
                        <div class="signature-box">
                            <label>USER/DRIVER</label>
                            <div class="signature-line" id="driverSign"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" id="driverStatus">[Pending]</div>
                        </div>
                        <div class="signature-box">
                            <label>APPROVED BY</label>
                            <div class="signature-line" id="managerSign"></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;" id="managerStatus">[Pending]</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="text-align: center; margin-top: 30px;" class="no-print">
                    <button type="button" class="btn" id="printBtn">Print Job Card</button>
                    <button type="button" class="btn" id="signatureBtn">Upload Signatures</button>
                </div>

                <!-- Hidden fields for signature data -->
                <input type="hidden" id="mechanicSignatureData" name="mechanicSignatureData" value="">
                <input type="hidden" id="driverSignatureData" name="driverSignatureData" value="">
                <input type="hidden" id="managerSignatureData" name="managerSignatureData" value="">
                <input type="hidden" id="currentJobId" value="">
            </form>
        </div>
    </div>

    <!-- Signature Upload Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <h2>Upload Signatures</h2>
            <p>Work Order: <strong id="modalWorkOrder"></strong></p>
            
            <div class="signature-link">
                <strong>🔧 Mechanic Signature:</strong><br>
                <input type="file" id="mechanicFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('mechanic')">Attach Signature</button>
                <div id="mechanicPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>👤 User/Driver Signature:</strong><br>
                <input type="file" id="driverFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('driver')">Attach Signature</button>
                <div id="driverPreview" style="margin-top:10px;"></div>
            </div>
            
            <div class="signature-link">
                <strong>✅ Manager Signature:</strong><br>
                <input type="file" id="managerFile" accept="image/*"><br>
                <button class="btn" onclick="attachSignature('manager')">Attach Signature</button>
                <div id="managerPreview" style="margin-top:10px;"></div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="saveSignatures()">Save All Signatures</button>
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - USING YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCf6aEITVY1RG_KZZT8MKc5otvbHxS80YA",
            authDomain: "ameeri-services-garage-s-1a50f.firebaseapp.com",
            projectId: "ameeri-services-garage-s-1a50f",
            storageBucket: "ameeri-services-garage-s-1a50f.firebasestorage.app",
            messagingSenderId: "183502312365",
            appId: "1:183502312365:web:cd6f8bb754c42202144724"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Set today's date
        document.getElementById('date').valueAsDate = new Date();

        // Initialize when page loads
        window.onload = function() {
            console.log("AMEERI Job Card System Started");

            const addBtn = document.getElementById('addBtn');
            const partsBody = document.getElementById('partsBody');
            const printBtn = document.getElementById('printBtn');
            const signatureBtn = document.getElementById('signatureBtn');
            const labourEl = document.getElementById('labour');

            if (addBtn) addBtn.addEventListener('click', addRow);
            if (printBtn) printBtn.addEventListener('click', () => window.print());
            if (signatureBtn) signatureBtn.addEventListener('click', showSignatureModal);
            if (labourEl) labourEl.addEventListener('input', calculateTotals);

            // Delegation for parts table
            if (partsBody) {
                partsBody.addEventListener('input', function(e) {
                    if (e.target && (e.target.matches('input[type="number"]'))) {
                        calculateTotals();
                    }
                });
                partsBody.addEventListener('click', function(e) {
                    if (e.target && e.target.matches('.remove-btn')) {
                        removeRow(e.target);
                    }
                });
            }

            // Load job card if URL has job ID
            loadJobCardFromUrl();

            calculateTotals();
        };

        // Add new row
        function addRow() {
            const tbody = document.getElementById('partsBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Part/Item"></td>
                <td><input type="number" value="1" min="1"></td>
                <td><input type="number" value="0" step="0.001"></td>
                <td><input type="text" placeholder="Service Performed"></td>
                <td class="no-print">
                    <button type="button" class="btn btn-small remove-btn">Remove</button>
                </td>
            `;
            tbody.appendChild(newRow);
            calculateTotals();
        }

        // Remove row
        function removeRow(button) {
            const row = button.closest('tr');
            if (row && document.querySelectorAll('#partsBody tr').length > 1) {
                row.remove();
                calculateTotals();
            }
        }

        // Calculate totals
        function calculateTotals() {
            let partsTotal = 0;
            const rows = document.querySelectorAll('#partsBody tr');

            rows.forEach((row) => {
                const qtyInput = row.querySelector('td:nth-child(2) input');
                const priceInput = row.querySelector('td:nth-child(3) input');

                const qty = parseFloat(qtyInput?.value) || 0;
                const price = parseFloat(priceInput?.value) || 0;
                const rowTotal = qty * price;

                partsTotal += rowTotal;
            });

            const labour = parseFloat(document.getElementById('labour')?.value) || 0;
            const grandTotal = partsTotal + labour;

            document.getElementById('totalParts').textContent = partsTotal.toFixed(3) + ' BD';
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(3) + ' BD';
        }

        // Collect form data
        function collectFormData() {
            const parts = [];
            document.querySelectorAll('#partsBody tr').forEach(row => {
                const partInput = row.querySelector('td:nth-child(1) input');
                const qtyInput = row.querySelector('td:nth-child(2) input');
                const priceInput = row.querySelector('td:nth-child(3) input');
                const serviceInput = row.querySelector('td:nth-child(4) input');
                
                parts.push({
                    part: partInput?.value || '',
                    qty: parseFloat(qtyInput?.value) || 0,
                    price: parseFloat(priceInput?.value) || 0,
                    service: serviceInput?.value || ''
                });
            });

            return {
                date: document.getElementById('date').value,
                workOrderNo: document.getElementById('workOrderNo').value,
                companyName: document.getElementById('companyName').value,
                userName: document.getElementById('userName').value,
                vehicleNo: document.getElementById('vehicleNo').value,
                mileage: document.getElementById('mileage').value,
                year: document.getElementById('year').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                parts: parts,
                labour: parseFloat(document.getElementById('labour').value) || 0,
                totalParts: document.getElementById('totalParts').textContent,
                grandTotal: document.getElementById('grandTotal').textContent,
                mechanicSignature: document.getElementById('mechanicSignatureData').value,
                driverSignature: document.getElementById('driverSignatureData').value,
                managerSignature: document.getElementById('managerSignatureData').value,
                createdAt: new Date().toISOString(),
                status: 'active'
            };
        }

        // Generate unique job ID
        function generateJobId() {
            return 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Save job card to Firebase and generate shareable link
        async function saveJobCardAndGenerateLink() {
            const jobData = collectFormData();
            const jobId = generateJobId();
            
            // Validate required fields
            if (!jobData.workOrderNo) {
                alert('Please enter Work Order No');
                return;
            }

            try {
                // Save to Firebase
                await db.collection('jobCards').doc(jobId).set({
                    ...jobData,
                    id: jobId
                });

                // Store current job ID
                document.getElementById('currentJobId').value = jobId;

                // Generate shareable link
                const shareLink = `${window.location.origin}${window.location.pathname}?job=${jobId}`;
                
                // Show link to user
                document.getElementById('shareLink').textContent = shareLink;
                document.getElementById('shareLinkContainer').style.display = 'block';
                document.getElementById('generateLinkBtn').style.display = 'none';
                
                alert('✅ Job card saved! Share the link to collect signatures.');
            } catch (error) {
                console.error('Error saving job card:', error);
                alert('❌ Error saving job card. Please try again.');
            }
        }

        // Load job card when someone opens shared link
        async function loadJobCardFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job');
            
            if (jobId) {
                try {
                    const doc = await db.collection('jobCards').doc(jobId).get();
                    if (doc.exists) {
                        const jobData = doc.data();
                        populateForm(jobData);
                        
                        // Hide save button for signature collectors
                        document.getElementById('generateLinkBtn').style.display = 'none';
                        document.getElementById('shareSection').style.display = 'none';
                        
                        // Show current job ID
                        document.getElementById('currentJobId').value = jobId;
                        
                        console.log('Job card loaded:', jobData.workOrderNo);
                    } else {
                        console.log('Job card not found:', jobId);
                    }
                } catch (error) {
                    console.error('Error loading job card:', error);
                }
            }
        }

        // Populate form with job data
        function populateForm(jobData) {
            document.getElementById('date').value = jobData.date;
            document.getElementById('workOrderNo').value = jobData.workOrderNo;
            document.getElementById('companyName').value = jobData.companyName || '';
            document.getElementById('userName').value = jobData.userName || '';
            document.getElementById('vehicleNo').value = jobData.vehicleNo || '';
            document.getElementById('mileage').value = jobData.mileage || '';
            document.getElementById('year').value = jobData.year || '';
            document.getElementById('make').value = jobData.make || '';
            document.getElementById('model').value = jobData.model || '';
            document.getElementById('labour').value = jobData.labour || 0;

            // Populate parts table
            const partsBody = document.getElementById('partsBody');
            partsBody.innerHTML = '';
            
            if (jobData.parts && jobData.parts.length > 0) {
                jobData.parts.forEach(part => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" value="${part.part}"></td>
                        <td><input type="number" value="${part.qty}" min="1"></td>
                        <td><input type="number" value="${part.price}" step="0.001"></td>
                        <td><input type="text" value="${part.service}"></td>
                        <td class="no-print">
                            <button type="button" class="btn btn-small remove-btn">Remove</button>
                        </td>
                    `;
                    partsBody.appendChild(row);
                });
            } else {
                // Add empty row if no parts
                addRow();
            }

            // Populate signatures if they exist
            if (jobData.mechanicSignature) {
                displaySignature('mechanic', jobData.mechanicSignature);
            }
            if (jobData.driverSignature) {
                displaySignature('driver', jobData.driverSignature);
            }
            if (jobData.managerSignature) {
                displaySignature('manager', jobData.managerSignature);
            }

            calculateTotals();
        }

        // Show signature modal
        function showSignatureModal() {
            const jobId = document.getElementById('currentJobId').value;
            const workOrder = document.getElementById('workOrderNo').value;
            
            if (!jobId && !workOrder) {
                alert('Please save the job card first or load an existing one');
                return;
            }

            document.getElementById('modalWorkOrder').textContent = workOrder || 'Not saved yet';
            document.getElementById('signatureModal').style.display = 'block';
        }

        // Attach signature locally
        function attachSignature(role) {
            const input = document.getElementById(role + 'File');
            if (!input || !input.files || input.files.length === 0) {
                alert('Choose an image file first.');
                return;
            }
            const file = input.files[0];
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;

                // Preview inside modal
                const preview = document.getElementById(role + 'Preview');
                if (preview) {
                    preview.innerHTML = '';
                    const pvImg = document.createElement('img');
                    pvImg.src = dataUrl;
                    pvImg.style.maxWidth = '100%';
                    pvImg.style.maxHeight = '120px';
                    preview.appendChild(pvImg);
                }

                // Store data URL on input element
                input.dataset.signatureData = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        // Save all signatures to Firebase
        async function saveSignatures() {
            const jobId = document.getElementById('currentJobId').value;
            if (!jobId) {
                alert('No job card loaded. Please save the job card first.');
                return;
            }

            try {
                const updates = {};
                let hasSignatures = false;

                // Check each role for new signatures
                ['mechanic', 'driver', 'manager'].forEach(role => {
                    const input = document.getElementById(role + 'File');
                    if (input && input.dataset.signatureData) {
                        updates[role + 'Signature'] = input.dataset.signatureData;
                        hasSignatures = true;
                        
                        // Display signature immediately
                        displaySignature(role, input.dataset.signatureData);
                    }
                });

                if (!hasSignatures) {
                    alert('No signatures to save. Please attach signatures first.');
                    return;
                }

                // Update Firebase
                await db.collection('jobCards').doc(jobId).update(updates);
                
                alert('✅ Signatures saved successfully!');
                closeModal();
            } catch (error) {
                console.error('Error saving signatures:', error);
                alert('❌ Error saving signatures. Please try again.');
            }
        }

        // Display signature on job card
        function displaySignature(role, dataUrl) {
            const signLine = document.getElementById(role + 'Sign');
            const status = document.getElementById(role + 'Status');
            
            if (signLine) {
                signLine.innerHTML = '';
                signLine.style.borderBottom = 'none';
                signLine.style.height = 'auto';
                signLine.style.padding = '6px 0';

                const img = document.createElement('img');
                img.src = dataUrl;
                img.alt = `${role} signature`;
                img.style.maxHeight = '40px';
                img.style.display = 'block';
                img.style.margin = '0 auto';

                signLine.appendChild(img);
            }

            if (status) {
                status.textContent = '[Signed]';
                status.style.color = 'green';
            }

            // Store in hidden field
            const hidden = document.getElementById(role + 'SignatureData');
            if (hidden) hidden.value = dataUrl;
        }

        // Copy share link to clipboard
        function copyShareLink() {
            const link = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        function closeModal() {
            document.getElementById('signatureModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target && event.target.id === 'signatureModal') closeModal();
        }
    </script>
</body>
</html>
